<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Setting up Endpoints – FullStack Authentication</title><meta name="description" content="Workshop for Frontend Masters to learn about authentication for your websites and webapps."/><meta name="og:description" content="Workshop for Frontend Masters to learn about authentication for your websites and webapps."/><meta name="og:title" content="Setting up Endpoints – FullStack Authentication"/><meta name="og:image" content="/authentication/images/social-share-cover.jpg"/><meta name="twitter:card" content="summary_large_image"/><meta name="next-head-count" content="8"/><link rel="preload" href="/authentication/_next/static/css/b1a10883d7f550d3.css" as="style"/><link rel="stylesheet" href="/authentication/_next/static/css/b1a10883d7f550d3.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/authentication/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/authentication/_next/static/chunks/webpack-cf5d923fdb720220.js" defer=""></script><script src="/authentication/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/authentication/_next/static/chunks/main-003259e7a3e93a5c.js" defer=""></script><script src="/authentication/_next/static/chunks/pages/_app-9e4d07e995b0a92b.js" defer=""></script><script src="/authentication/_next/static/chunks/pages/lessons/%5Bsection%5D/%5Bslug%5D-325cda38693db656.js" defer=""></script><script src="/authentication/_next/static/PPKJLCZ4kWFtkdu6sn9sr/_buildManifest.js" defer=""></script><script src="/authentication/_next/static/PPKJLCZ4kWFtkdu6sn9sr/_ssgManifest.js" defer=""></script><script src="/authentication/_next/static/PPKJLCZ4kWFtkdu6sn9sr/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="remix-app"><header class="navbar"><h1 class="navbar-brand"><a href="/authentication">FullStack Authentication</a></h1><div class="navbar-info"><a href="https://frontendmasters.com/courses/authentication/" class="cta-btn">Watch on Frontend Masters</a></div></header><div class="content-container"><div class="main"><div class="lesson-container"><div class="lesson"><div class="lesson-content"><h1 id="setting-up-endpoints-for-webauthn">Setting Up endpoints for WebAuthn</h1>
<p>Now, the largest part: implementing WebAuthn in our server</p>
<h2 id="registration-endpoints">Registration endpoints</h2>
<pre><code class="hljs language-js">app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/auth/webauth-registration-options&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span>{
    <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">findUser</span>(req.<span class="hljs-property">body</span>.<span class="hljs-property">email</span>);

    <span class="hljs-keyword">const</span> options = {
        <span class="hljs-attr">rpName</span>: <span class="hljs-string">&#x27;Coffee Masters&#x27;</span>,
        rpID,
        <span class="hljs-attr">userID</span>: user.<span class="hljs-property">email</span>,
        <span class="hljs-attr">userName</span>: user.<span class="hljs-property">name</span>,
        <span class="hljs-attr">timeout</span>: <span class="hljs-number">60000</span>,
        <span class="hljs-attr">attestationType</span>: <span class="hljs-string">&#x27;none&#x27;</span>,
        
        <span class="hljs-comment">/**
         * Passing in a user&#x27;s list of already-registered authenticator IDs here prevents users from
         * registering the same device multiple times. The authenticator will simply throw an error in
         * the browser if it&#x27;s asked to perform registration when one of these ID&#x27;s already resides
         * on it.
         */</span>
        <span class="hljs-attr">excludeCredentials</span>: user.<span class="hljs-property">devices</span> ? user.<span class="hljs-property">devices</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">dev</span> =&gt;</span> ({
            <span class="hljs-attr">id</span>: dev.<span class="hljs-property">credentialID</span>,
            <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;public-key&#x27;</span>,
            <span class="hljs-attr">transports</span>: dev.<span class="hljs-property">transports</span>,
        })) : [],

        <span class="hljs-attr">authenticatorSelection</span>: {
            <span class="hljs-attr">userVerification</span>: <span class="hljs-string">&#x27;required&#x27;</span>, 
            <span class="hljs-attr">residentKey</span>: <span class="hljs-string">&#x27;required&#x27;</span>,
        },
        <span class="hljs-comment">/**
         * The two most common algorithms: ES256, and RS256
         */</span>
        <span class="hljs-attr">supportedAlgorithmIDs</span>: [-<span class="hljs-number">7</span>, -<span class="hljs-number">257</span>],
    };

    <span class="hljs-comment">/**
     * The server needs to temporarily remember this value for verification, so don&#x27;t lose it until
     * after you verify an authenticator response.
     */</span>
    <span class="hljs-keyword">const</span> regOptions = <span class="hljs-title class_">SimpleWebAuthnServer</span>.<span class="hljs-title function_">generateRegistrationOptions</span>(options)
    user.<span class="hljs-property">currentChallenge</span> = regOptions.<span class="hljs-property">challenge</span>;
    db.<span class="hljs-title function_">write</span>();
    
    res.<span class="hljs-title function_">send</span>(regOptions);
});

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/auth/webauth-registration-verification&quot;</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
    <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">findUser</span>(req.<span class="hljs-property">body</span>.<span class="hljs-property">user</span>.<span class="hljs-property">email</span>);
    <span class="hljs-keyword">const</span> data = req.<span class="hljs-property">body</span>.<span class="hljs-property">data</span>;
  
    <span class="hljs-keyword">const</span> expectedChallenge = user.<span class="hljs-property">currentChallenge</span>;
  
    <span class="hljs-keyword">let</span> verification;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> options = {
        <span class="hljs-attr">credential</span>: data,
        <span class="hljs-attr">expectedChallenge</span>: <span class="hljs-string">`<span class="hljs-subst">${expectedChallenge}</span>`</span>,
        expectedOrigin,
        <span class="hljs-attr">expectedRPID</span>: rpID,
        <span class="hljs-attr">requireUserVerification</span>: <span class="hljs-literal">true</span>,
      };
      verification = <span class="hljs-keyword">await</span> <span class="hljs-title class_">SimpleWebAuthnServer</span>.<span class="hljs-title function_">verifyRegistrationResponse</span>(options);
    } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error);
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>({ <span class="hljs-attr">error</span>: error.<span class="hljs-title function_">toString</span>() });
    }
  
    <span class="hljs-keyword">const</span> { verified, registrationInfo } = verification;
  
    <span class="hljs-keyword">if</span> (verified &amp;&amp; registrationInfo) {
      <span class="hljs-keyword">const</span> { credentialPublicKey, credentialID, counter } = registrationInfo;
  
      <span class="hljs-keyword">const</span> existingDevice = user.<span class="hljs-property">devices</span> ? user.<span class="hljs-property">devices</span>.<span class="hljs-title function_">find</span>(
        <span class="hljs-function"><span class="hljs-params">device</span> =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Buffer</span>(device.<span class="hljs-property">credentialID</span>.<span class="hljs-property">data</span>).<span class="hljs-title function_">equals</span>(credentialID)
      ) : <span class="hljs-literal">false</span>;
  
      <span class="hljs-keyword">if</span> (!existingDevice) {
        <span class="hljs-keyword">const</span> newDevice = {
          credentialPublicKey,
          credentialID,
          counter,
          <span class="hljs-attr">transports</span>: data.<span class="hljs-property">transports</span>,
        };
        <span class="hljs-keyword">if</span> (user.<span class="hljs-property">devices</span>==<span class="hljs-literal">undefined</span>) {
            user.<span class="hljs-property">devices</span> = [];
        }
        user.<span class="hljs-property">webauthn</span> = <span class="hljs-literal">true</span>;
        user.<span class="hljs-property">devices</span>.<span class="hljs-title function_">push</span>(newDevice);
        db.<span class="hljs-title function_">write</span>();
      }
    }
  
    res.<span class="hljs-title function_">send</span>({ <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span> });

});
</code></pre>
<h2 id="loginauthentication-endpoints">Login/Authentication Endpoints</h2>
<pre><code class="hljs language-js">

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/auth/webauth-login-options&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span>{
    <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">findUser</span>(req.<span class="hljs-property">body</span>.<span class="hljs-property">email</span>);
    <span class="hljs-comment">// if (user==null) {</span>
    <span class="hljs-comment">//     res.sendStatus(404);</span>
    <span class="hljs-comment">//     return;</span>
    <span class="hljs-comment">// }</span>
    <span class="hljs-keyword">const</span> options = {
        <span class="hljs-attr">timeout</span>: <span class="hljs-number">60000</span>,
        <span class="hljs-attr">allowCredentials</span>: [],
        <span class="hljs-attr">devices</span>: user &amp;&amp; user.<span class="hljs-property">devices</span> ? user.<span class="hljs-property">devices</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">dev</span> =&gt;</span> ({
          <span class="hljs-attr">id</span>: dev.<span class="hljs-property">credentialID</span>,
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;public-key&#x27;</span>,
          <span class="hljs-attr">transports</span>: dev.<span class="hljs-property">transports</span>,
        })) : [],
        <span class="hljs-attr">userVerification</span>: <span class="hljs-string">&#x27;required&#x27;</span>,
        rpID,
    };
    <span class="hljs-keyword">const</span> loginOpts = <span class="hljs-title class_">SimpleWebAuthnServer</span>.<span class="hljs-title function_">generateAuthenticationOptions</span>(options);
    <span class="hljs-keyword">if</span> (user) user.<span class="hljs-property">currentChallenge</span> = loginOpts.<span class="hljs-property">challenge</span>;
    res.<span class="hljs-title function_">send</span>(loginOpts);
});

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/auth/webauth-login-verification&quot;</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
    <span class="hljs-keyword">const</span> data = req.<span class="hljs-property">body</span>.<span class="hljs-property">data</span>;
    <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">findUser</span>(req.<span class="hljs-property">body</span>.<span class="hljs-property">email</span>);
    <span class="hljs-keyword">if</span> (user==<span class="hljs-literal">null</span>) {
        res.<span class="hljs-title function_">sendStatus</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>({<span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>});
        <span class="hljs-keyword">return</span>;
    } 
  
    <span class="hljs-keyword">const</span> expectedChallenge = user.<span class="hljs-property">currentChallenge</span>;
  
    <span class="hljs-keyword">let</span> dbAuthenticator;
    <span class="hljs-keyword">const</span> bodyCredIDBuffer = base64url.<span class="hljs-title function_">toBuffer</span>(data.<span class="hljs-property">rawId</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> dev <span class="hljs-keyword">of</span> user.<span class="hljs-property">devices</span>) {
      <span class="hljs-keyword">const</span> currentCredential = <span class="hljs-title class_">Buffer</span>(dev.<span class="hljs-property">credentialID</span>.<span class="hljs-property">data</span>);
      <span class="hljs-keyword">if</span> (bodyCredIDBuffer.<span class="hljs-title function_">equals</span>(currentCredential)) {
        dbAuthenticator = dev;
        <span class="hljs-keyword">break</span>;
      }
    }

    <span class="hljs-keyword">if</span> (!dbAuthenticator) {
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>({ <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Authenticator is not registered with this site&#x27;</span> });
    }
  
    <span class="hljs-keyword">let</span> verification;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> options  = {
        <span class="hljs-attr">credential</span>: data,
        <span class="hljs-attr">expectedChallenge</span>: <span class="hljs-string">`<span class="hljs-subst">${expectedChallenge}</span>`</span>,
        expectedOrigin,
        <span class="hljs-attr">expectedRPID</span>: rpID,
        <span class="hljs-attr">authenticator</span>: {
            ...dbAuthenticator,
            <span class="hljs-attr">credentialPublicKey</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Buffer</span>(dbAuthenticator.<span class="hljs-property">credentialPublicKey</span>.<span class="hljs-property">data</span>) <span class="hljs-comment">// Re-convert to Buffer from JSON</span>
        },
        <span class="hljs-attr">requireUserVerification</span>: <span class="hljs-literal">true</span>,
      };
      verification = <span class="hljs-keyword">await</span> <span class="hljs-title class_">SimpleWebAuthnServer</span>.<span class="hljs-title function_">verifyAuthenticationResponse</span>(options);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>({ <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: error.<span class="hljs-title function_">toString</span>() });
    }
  
    <span class="hljs-keyword">const</span> { verified, authenticationInfo } = verification;
  
    <span class="hljs-keyword">if</span> (verified) {
      dbAuthenticator.<span class="hljs-property">counter</span> = authenticationInfo.<span class="hljs-property">newCounter</span>;
    }
  
    res.<span class="hljs-title function_">send</span>({ 
        <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, 
        <span class="hljs-attr">user</span>: {
            <span class="hljs-attr">name</span>: user.<span class="hljs-property">name</span>, 
            <span class="hljs-attr">email</span>: user.<span class="hljs-property">email</span>
        }
    });
});
</code></pre>
<p>Finally, we add these endpoints to <code>API.js</code></p>
<pre><code class="hljs language-js"><span class="hljs-attr">webAuthn</span>: {
    <span class="hljs-attr">loginOptions</span>: <span class="hljs-keyword">async</span> (email) =&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable constant_">API</span>.<span class="hljs-title function_">makePostRequest</span>(<span class="hljs-variable constant_">API</span>.<span class="hljs-property">endpoint</span> + <span class="hljs-string">&quot;webauth-login-options&quot;</span>, { email });
    },
    <span class="hljs-attr">loginVerification</span>: <span class="hljs-keyword">async</span> (email, data) =&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable constant_">API</span>.<span class="hljs-title function_">makePostRequest</span>(<span class="hljs-variable constant_">API</span>.<span class="hljs-property">endpoint</span> + <span class="hljs-string">&quot;webauth-login-verification&quot;</span>, {
            email,
            data
        });                       
    },
    <span class="hljs-attr">registrationOptions</span>: <span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable constant_">API</span>.<span class="hljs-title function_">makePostRequest</span>(<span class="hljs-variable constant_">API</span>.<span class="hljs-property">endpoint</span> + <span class="hljs-string">&quot;webauth-registration-options&quot;</span>, <span class="hljs-title class_">Auth</span>.<span class="hljs-property">account</span>);           
    },
    <span class="hljs-attr">registrationVerification</span>: <span class="hljs-keyword">async</span> (data) =&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable constant_">API</span>.<span class="hljs-title function_">makePostRequest</span>(<span class="hljs-variable constant_">API</span>.<span class="hljs-property">endpoint</span> + <span class="hljs-string">&quot;webauth-registration-verification&quot;</span>, {
            <span class="hljs-attr">user</span>: <span class="hljs-title class_">Auth</span>.<span class="hljs-property">account</span>,
            data
        });                       
    }
},
</code></pre>
</div><div class="lesson-links"><a href="/authentication/lessons/using-webauthn/endpoints-flow" class="prev">← Previous</a><a href="/authentication/lessons/using-webauthn/registering-authentication" class="next">Next →</a></div></div><div class="details-bg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="154" height="154" viewBox="0 0 154 154"><defs><clipPath id="clip-path"><rect id="Rectangle_2238" data-name="Rectangle 2238" width="154" height="154" transform="translate(9467 350)" fill="#fff" stroke="#707070" stroke-width="1"></rect></clipPath><clipPath id="clip-corner-image-active"><rect width="154" height="154"></rect></clipPath></defs><g id="corner-image-active" clip-path="url(#clip-corner-image-active)"><g id="Corner-image-active-2" data-name="Corner-image-active" transform="translate(-9467 -350)" clip-path="url(#clip-path)"><path id="Subtraction_34" data-name="Subtraction 34" d="M-3857.365,1740.766h0l-7.07-7.07,12.89-12.89v14.142l-5.818,5.818Zm-14.142-14.142h0l-7.071-7.07,27.033-27.033v14.143l-19.96,19.96Zm-14.143-14.143h0l-7.07-7.069,41.175-41.175v14.142Zm-14.142-14.142h0l-7.07-7.069,55.317-55.317v14.142Zm-14.142-14.142h0l-7.07-7.069,69.459-69.459v14.142Zm-14.142-14.142h0l-7.07-7.069,76.739-76.739h6.862v7.28Zm-14.143-14.143h0l-7.07-7.069,62.6-62.6h14.142Zm-14.142-14.142h0l-7.07-7.069,48.454-48.454h14.142Zm-14.142-14.142h0l-7.07-7.069,34.312-34.312h14.142Zm-14.142-14.142h0l-7.07-7.069,20.17-20.17h14.142Zm-14.142-14.142h0l-7.071-7.071,6.027-6.027h14.144l-13.1,13.1Zm367.24-56.114v-.909l.455.455-.453.453Z" transform="translate(13472.546 -1236.766)" fill="var(--corner-fill)"></path></g></g></svg></div></div></div></div><footer class="footer"><ul class="socials"><li class="social"><a href="https://twitter.com/firt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="40" height="32" viewBox="0 0 40 32"><defs><clipPath id="clip-twitter-social"><rect width="40" height="32"></rect></clipPath></defs><g id="twitter-social" clip-path="url(#clip-twitter-social)"><g id="Group_269" data-name="Group 269" transform="translate(-230.23 -1140.849)"><path id="Path_419" data-name="Path 419" d="M266.12,1148.861v1.035a23.092,23.092,0,0,1-1.507,8.1,24.08,24.08,0,0,1-4.475,7.381,22.175,22.175,0,0,1-7.306,5.4,24.129,24.129,0,0,1-10,2.07,23.7,23.7,0,0,1-6.667-.945,22.83,22.83,0,0,1-5.936-2.655q.959.091,1.963.09a16.518,16.518,0,0,0,5.434-.9,17.111,17.111,0,0,0,4.749-2.52,8.275,8.275,0,0,1-4.749-1.643,7.8,7.8,0,0,1-2.877-3.983,8.268,8.268,0,0,0,1.507.135,8.58,8.58,0,0,0,2.146-.27,8.16,8.16,0,0,1-5.685-4.344,8.326,8.326,0,0,1-.89-3.578v-.135a7.775,7.775,0,0,0,3.744,1.035,8.183,8.183,0,0,1-2.671-2.9,7.817,7.817,0,0,1-.982-3.848,7.948,7.948,0,0,1,1.1-4.05,23.53,23.53,0,0,0,16.895,8.46,9.221,9.221,0,0,1-.183-1.845,7.787,7.787,0,0,1,1.1-4.05,8.216,8.216,0,0,1,2.991-2.948,7.991,7.991,0,0,1,4.087-1.1,8.184,8.184,0,0,1,5.982,2.566,16.087,16.087,0,0,0,5.205-1.98,7.784,7.784,0,0,1-1.393,2.588,8.4,8.4,0,0,1-2.215,1.913,16.856,16.856,0,0,0,4.749-1.305A17.032,17.032,0,0,1,266.12,1148.861Z" fill="var(--icons)"></path></g></g></svg></a></li><li class="social"><a href="https://github.com/firtman"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-github-social"><rect width="32" height="32"></rect></clipPath></defs><g id="github-social" clip-path="url(#clip-github-social)"><g id="Group_272" data-name="Group 272" transform="translate(13522.5 -6994)"><path id="Subtraction_33" data-name="Subtraction 33" d="M-24967.5,8041a15.9,15.9,0,0,1-11.312-4.688A15.893,15.893,0,0,1-24983.5,8025a15.893,15.893,0,0,1,4.689-11.315A15.894,15.894,0,0,1-24967.5,8009a15.894,15.894,0,0,1,11.313,4.686A15.893,15.893,0,0,1-24951.5,8025a15.893,15.893,0,0,1-4.689,11.313A15.9,15.9,0,0,1-24967.5,8041Zm-3.781-4.571h0v3.918h7.895v-6.665a1.836,1.836,0,0,0-1.2-1.718c5.1-.617,7.467-2.975,7.467-7.424a7.176,7.176,0,0,0-1.637-4.728,6.74,6.74,0,0,0,.275-1.812,4.34,4.34,0,0,0-.52-2.452.574.574,0,0,0-.359-.1c-1.061,0-3.465,1.411-3.936,1.694a16.644,16.644,0,0,0-4.2-.489,16.379,16.379,0,0,0-3.969.445c-.846-.5-2.91-1.649-3.859-1.649a.566.566,0,0,0-.354.095,4.3,4.3,0,0,0-.521,2.452,6.7,6.7,0,0,0,.244,1.718,7.346,7.346,0,0,0-1.6,4.822,7.263,7.263,0,0,0,1.533,4.985c1.193,1.359,3.115,2.165,5.871,2.464a1.826,1.826,0,0,0-1.129,1.693v.5h0l-.006,0a7.121,7.121,0,0,1-2.033.363,2.608,2.608,0,0,1-.965-.158,4.438,4.438,0,0,1-1.836-1.881,2.361,2.361,0,0,0-1.248-1.091,3.472,3.472,0,0,0-1.217-.3.584.584,0,0,0-.545.224.282.282,0,0,0,.027.367,1.875,1.875,0,0,0,.447.307,4.732,4.732,0,0,1,.561.355,10.726,10.726,0,0,1,1.682,2.755c.043.092.078.163.105.217a3.876,3.876,0,0,0,2.42,1.185,6.036,6.036,0,0,0,.607.025c.875,0,1.988-.124,2-.125Z" transform="translate(11461 -1015)" fill="var(--icons)"></path><g id="Ellipse_670" data-name="Ellipse 670" transform="translate(-13522.5 6994)" fill="none" stroke="var(--icons)" stroke-width="1"><circle cx="16" cy="16" r="16" stroke="none"></circle><circle cx="16" cy="16" r="15.5" fill="none"></circle></g></g></g></svg></a></li><li class="social"><a href="https://linkedin.com/in/firtman"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-linkedin-social"><rect width="32" height="32"></rect></clipPath></defs><g id="linkedin-social" clip-path="url(#clip-linkedin-social)"><g id="Group_270" data-name="Group 270" transform="translate(-86.349 -633.073)"><path id="Path_375" data-name="Path 375" d="M115.789,633.073a2.324,2.324,0,0,1,1.682.676,2.194,2.194,0,0,1,.695,1.627V662.8a2.131,2.131,0,0,1-.695,1.609,2.314,2.314,0,0,1-1.646.659H88.69a2.307,2.307,0,0,1-1.646-.659,2.128,2.128,0,0,1-.695-1.609V635.376a2.19,2.19,0,0,1,.695-1.627,2.322,2.322,0,0,1,1.682-.676h27.063Zm-20.224,9.672a2.561,2.561,0,0,0,0-3.584,2.658,2.658,0,0,0-1.938-.712,2.724,2.724,0,0,0-1.957.712,2.371,2.371,0,0,0-.75,1.792,2.4,2.4,0,0,0,.731,1.792,2.605,2.605,0,0,0,1.9.713h.037A2.7,2.7,0,0,0,95.565,642.745ZM96,645.434H91.213V659.88H96Zm17.3,6.144a7.007,7.007,0,0,0-1.573-4.9,5.68,5.68,0,0,0-6.839-.769,5.663,5.663,0,0,0-1.426,1.573v-2.048H98.674q.036.841,0,7.717v6.728h4.791V651.8a3.592,3.592,0,0,1,.146-1.17,2.913,2.913,0,0,1,.878-1.206,2.429,2.429,0,0,1,1.609-.549,2.108,2.108,0,0,1,1.865.914,4.265,4.265,0,0,1,.549,2.341v7.752H113.3Z" fill="var(--icons)"></path></g></g></svg></a></li><li class="social"><div class="terms"><p>Content Licensed Under CC-BY-NC-4.0</p><p>Code Samples and Excercises Licensed Under Apache 2.0</p><p>Site Designed by<!-- --> <a href="https://www.alexdanielson.com/">Alex Danielson</a></p></div></li></ul></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"attributes":{},"html":"\u003ch1 id=\"setting-up-endpoints-for-webauthn\"\u003eSetting Up endpoints for WebAuthn\u003c/h1\u003e\n\u003cp\u003eNow, the largest part: implementing WebAuthn in our server\u003c/p\u003e\n\u003ch2 id=\"registration-endpoints\"\u003eRegistration endpoints\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003eapp.\u003cspan class=\"hljs-title function_\"\u003epost\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/auth/webauth-registration-options\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ereq, res\u003c/span\u003e) =\u0026gt;\u003c/span\u003e{\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e user = \u003cspan class=\"hljs-title function_\"\u003efindUser\u003c/span\u003e(req.\u003cspan class=\"hljs-property\"\u003ebody\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eemail\u003c/span\u003e);\n\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e options = {\n        \u003cspan class=\"hljs-attr\"\u003erpName\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;Coffee Masters\u0026#x27;\u003c/span\u003e,\n        rpID,\n        \u003cspan class=\"hljs-attr\"\u003euserID\u003c/span\u003e: user.\u003cspan class=\"hljs-property\"\u003eemail\u003c/span\u003e,\n        \u003cspan class=\"hljs-attr\"\u003euserName\u003c/span\u003e: user.\u003cspan class=\"hljs-property\"\u003ename\u003c/span\u003e,\n        \u003cspan class=\"hljs-attr\"\u003etimeout\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e60000\u003c/span\u003e,\n        \u003cspan class=\"hljs-attr\"\u003eattestationType\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;none\u0026#x27;\u003c/span\u003e,\n        \n        \u003cspan class=\"hljs-comment\"\u003e/**\n         * Passing in a user\u0026#x27;s list of already-registered authenticator IDs here prevents users from\n         * registering the same device multiple times. The authenticator will simply throw an error in\n         * the browser if it\u0026#x27;s asked to perform registration when one of these ID\u0026#x27;s already resides\n         * on it.\n         */\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003eexcludeCredentials\u003c/span\u003e: user.\u003cspan class=\"hljs-property\"\u003edevices\u003c/span\u003e ? user.\u003cspan class=\"hljs-property\"\u003edevices\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003emap\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003edev\u003c/span\u003e =\u0026gt;\u003c/span\u003e ({\n            \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e: dev.\u003cspan class=\"hljs-property\"\u003ecredentialID\u003c/span\u003e,\n            \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;public-key\u0026#x27;\u003c/span\u003e,\n            \u003cspan class=\"hljs-attr\"\u003etransports\u003c/span\u003e: dev.\u003cspan class=\"hljs-property\"\u003etransports\u003c/span\u003e,\n        })) : [],\n\n        \u003cspan class=\"hljs-attr\"\u003eauthenticatorSelection\u003c/span\u003e: {\n            \u003cspan class=\"hljs-attr\"\u003euserVerification\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;required\u0026#x27;\u003c/span\u003e, \n            \u003cspan class=\"hljs-attr\"\u003eresidentKey\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;required\u0026#x27;\u003c/span\u003e,\n        },\n        \u003cspan class=\"hljs-comment\"\u003e/**\n         * The two most common algorithms: ES256, and RS256\n         */\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003esupportedAlgorithmIDs\u003c/span\u003e: [-\u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e, -\u003cspan class=\"hljs-number\"\u003e257\u003c/span\u003e],\n    };\n\n    \u003cspan class=\"hljs-comment\"\u003e/**\n     * The server needs to temporarily remember this value for verification, so don\u0026#x27;t lose it until\n     * after you verify an authenticator response.\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e regOptions = \u003cspan class=\"hljs-title class_\"\u003eSimpleWebAuthnServer\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003egenerateRegistrationOptions\u003c/span\u003e(options)\n    user.\u003cspan class=\"hljs-property\"\u003ecurrentChallenge\u003c/span\u003e = regOptions.\u003cspan class=\"hljs-property\"\u003echallenge\u003c/span\u003e;\n    db.\u003cspan class=\"hljs-title function_\"\u003ewrite\u003c/span\u003e();\n    \n    res.\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e(regOptions);\n});\n\napp.\u003cspan class=\"hljs-title function_\"\u003epost\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/auth/webauth-registration-verification\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e (req, res) =\u0026gt; {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e user = \u003cspan class=\"hljs-title function_\"\u003efindUser\u003c/span\u003e(req.\u003cspan class=\"hljs-property\"\u003ebody\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003euser\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eemail\u003c/span\u003e);\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e data = req.\u003cspan class=\"hljs-property\"\u003ebody\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edata\u003c/span\u003e;\n  \n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e expectedChallenge = user.\u003cspan class=\"hljs-property\"\u003ecurrentChallenge\u003c/span\u003e;\n  \n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e verification;\n    \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e options = {\n        \u003cspan class=\"hljs-attr\"\u003ecredential\u003c/span\u003e: data,\n        \u003cspan class=\"hljs-attr\"\u003eexpectedChallenge\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${expectedChallenge}\u003c/span\u003e`\u003c/span\u003e,\n        expectedOrigin,\n        \u003cspan class=\"hljs-attr\"\u003eexpectedRPID\u003c/span\u003e: rpID,\n        \u003cspan class=\"hljs-attr\"\u003erequireUserVerification\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e,\n      };\n      verification = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSimpleWebAuthnServer\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003everifyRegistrationResponse\u003c/span\u003e(options);\n    } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (error) {\n    \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(error);\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e res.\u003cspan class=\"hljs-title function_\"\u003estatus\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e400\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003eerror\u003c/span\u003e: error.\u003cspan class=\"hljs-title function_\"\u003etoString\u003c/span\u003e() });\n    }\n  \n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { verified, registrationInfo } = verification;\n  \n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (verified \u0026amp;\u0026amp; registrationInfo) {\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { credentialPublicKey, credentialID, counter } = registrationInfo;\n  \n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e existingDevice = user.\u003cspan class=\"hljs-property\"\u003edevices\u003c/span\u003e ? user.\u003cspan class=\"hljs-property\"\u003edevices\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003efind\u003c/span\u003e(\n        \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003edevice\u003c/span\u003e =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBuffer\u003c/span\u003e(device.\u003cspan class=\"hljs-property\"\u003ecredentialID\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edata\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003eequals\u003c/span\u003e(credentialID)\n      ) : \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\n  \n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!existingDevice) {\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e newDevice = {\n          credentialPublicKey,\n          credentialID,\n          counter,\n          \u003cspan class=\"hljs-attr\"\u003etransports\u003c/span\u003e: data.\u003cspan class=\"hljs-property\"\u003etransports\u003c/span\u003e,\n        };\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (user.\u003cspan class=\"hljs-property\"\u003edevices\u003c/span\u003e==\u003cspan class=\"hljs-literal\"\u003eundefined\u003c/span\u003e) {\n            user.\u003cspan class=\"hljs-property\"\u003edevices\u003c/span\u003e = [];\n        }\n        user.\u003cspan class=\"hljs-property\"\u003ewebauthn\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\n        user.\u003cspan class=\"hljs-property\"\u003edevices\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003epush\u003c/span\u003e(newDevice);\n        db.\u003cspan class=\"hljs-title function_\"\u003ewrite\u003c/span\u003e();\n      }\n    }\n  \n    res.\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003eok\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e });\n\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"loginauthentication-endpoints\"\u003eLogin/Authentication Endpoints\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\n\napp.\u003cspan class=\"hljs-title function_\"\u003epost\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/auth/webauth-login-options\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ereq, res\u003c/span\u003e) =\u0026gt;\u003c/span\u003e{\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e user = \u003cspan class=\"hljs-title function_\"\u003efindUser\u003c/span\u003e(req.\u003cspan class=\"hljs-property\"\u003ebody\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eemail\u003c/span\u003e);\n    \u003cspan class=\"hljs-comment\"\u003e// if (user==null) {\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e//     res.sendStatus(404);\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e//     return;\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e// }\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e options = {\n        \u003cspan class=\"hljs-attr\"\u003etimeout\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e60000\u003c/span\u003e,\n        \u003cspan class=\"hljs-attr\"\u003eallowCredentials\u003c/span\u003e: [],\n        \u003cspan class=\"hljs-attr\"\u003edevices\u003c/span\u003e: user \u0026amp;\u0026amp; user.\u003cspan class=\"hljs-property\"\u003edevices\u003c/span\u003e ? user.\u003cspan class=\"hljs-property\"\u003edevices\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003emap\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003edev\u003c/span\u003e =\u0026gt;\u003c/span\u003e ({\n          \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e: dev.\u003cspan class=\"hljs-property\"\u003ecredentialID\u003c/span\u003e,\n          \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;public-key\u0026#x27;\u003c/span\u003e,\n          \u003cspan class=\"hljs-attr\"\u003etransports\u003c/span\u003e: dev.\u003cspan class=\"hljs-property\"\u003etransports\u003c/span\u003e,\n        })) : [],\n        \u003cspan class=\"hljs-attr\"\u003euserVerification\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;required\u0026#x27;\u003c/span\u003e,\n        rpID,\n    };\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e loginOpts = \u003cspan class=\"hljs-title class_\"\u003eSimpleWebAuthnServer\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003egenerateAuthenticationOptions\u003c/span\u003e(options);\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (user) user.\u003cspan class=\"hljs-property\"\u003ecurrentChallenge\u003c/span\u003e = loginOpts.\u003cspan class=\"hljs-property\"\u003echallenge\u003c/span\u003e;\n    res.\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e(loginOpts);\n});\n\napp.\u003cspan class=\"hljs-title function_\"\u003epost\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/auth/webauth-login-verification\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e (req, res) =\u0026gt; {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e data = req.\u003cspan class=\"hljs-property\"\u003ebody\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edata\u003c/span\u003e;\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e user = \u003cspan class=\"hljs-title function_\"\u003efindUser\u003c/span\u003e(req.\u003cspan class=\"hljs-property\"\u003ebody\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eemail\u003c/span\u003e);\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (user==\u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\n        res.\u003cspan class=\"hljs-title function_\"\u003esendStatus\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e400\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e({\u003cspan class=\"hljs-attr\"\u003eok\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e});\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\n    } \n  \n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e expectedChallenge = user.\u003cspan class=\"hljs-property\"\u003ecurrentChallenge\u003c/span\u003e;\n  \n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e dbAuthenticator;\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e bodyCredIDBuffer = base64url.\u003cspan class=\"hljs-title function_\"\u003etoBuffer\u003c/span\u003e(data.\u003cspan class=\"hljs-property\"\u003erawId\u003c/span\u003e);\n\n    \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e dev \u003cspan class=\"hljs-keyword\"\u003eof\u003c/span\u003e user.\u003cspan class=\"hljs-property\"\u003edevices\u003c/span\u003e) {\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e currentCredential = \u003cspan class=\"hljs-title class_\"\u003eBuffer\u003c/span\u003e(dev.\u003cspan class=\"hljs-property\"\u003ecredentialID\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edata\u003c/span\u003e);\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (bodyCredIDBuffer.\u003cspan class=\"hljs-title function_\"\u003eequals\u003c/span\u003e(currentCredential)) {\n        dbAuthenticator = dev;\n        \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\n      }\n    }\n\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!dbAuthenticator) {\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e res.\u003cspan class=\"hljs-title function_\"\u003estatus\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e400\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003eok\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003emessage\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;Authenticator is not registered with this site\u0026#x27;\u003c/span\u003e });\n    }\n  \n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e verification;\n    \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e options  = {\n        \u003cspan class=\"hljs-attr\"\u003ecredential\u003c/span\u003e: data,\n        \u003cspan class=\"hljs-attr\"\u003eexpectedChallenge\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${expectedChallenge}\u003c/span\u003e`\u003c/span\u003e,\n        expectedOrigin,\n        \u003cspan class=\"hljs-attr\"\u003eexpectedRPID\u003c/span\u003e: rpID,\n        \u003cspan class=\"hljs-attr\"\u003eauthenticator\u003c/span\u003e: {\n            ...dbAuthenticator,\n            \u003cspan class=\"hljs-attr\"\u003ecredentialPublicKey\u003c/span\u003e: \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBuffer\u003c/span\u003e(dbAuthenticator.\u003cspan class=\"hljs-property\"\u003ecredentialPublicKey\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edata\u003c/span\u003e) \u003cspan class=\"hljs-comment\"\u003e// Re-convert to Buffer from JSON\u003c/span\u003e\n        },\n        \u003cspan class=\"hljs-attr\"\u003erequireUserVerification\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e,\n      };\n      verification = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSimpleWebAuthnServer\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003everifyAuthenticationResponse\u003c/span\u003e(options);\n    } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (error) {\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e res.\u003cspan class=\"hljs-title function_\"\u003estatus\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e400\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003eok\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003emessage\u003c/span\u003e: error.\u003cspan class=\"hljs-title function_\"\u003etoString\u003c/span\u003e() });\n    }\n  \n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { verified, authenticationInfo } = verification;\n  \n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (verified) {\n      dbAuthenticator.\u003cspan class=\"hljs-property\"\u003ecounter\u003c/span\u003e = authenticationInfo.\u003cspan class=\"hljs-property\"\u003enewCounter\u003c/span\u003e;\n    }\n  \n    res.\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e({ \n        \u003cspan class=\"hljs-attr\"\u003eok\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e, \n        \u003cspan class=\"hljs-attr\"\u003euser\u003c/span\u003e: {\n            \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e: user.\u003cspan class=\"hljs-property\"\u003ename\u003c/span\u003e, \n            \u003cspan class=\"hljs-attr\"\u003eemail\u003c/span\u003e: user.\u003cspan class=\"hljs-property\"\u003eemail\u003c/span\u003e\n        }\n    });\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFinally, we add these endpoints to \u003ccode\u003eAPI.js\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-attr\"\u003ewebAuthn\u003c/span\u003e: {\n    \u003cspan class=\"hljs-attr\"\u003eloginOptions\u003c/span\u003e: \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e (email) =\u0026gt; {\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eAPI\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003emakePostRequest\u003c/span\u003e(\u003cspan class=\"hljs-variable constant_\"\u003eAPI\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eendpoint\u003c/span\u003e + \u003cspan class=\"hljs-string\"\u003e\u0026quot;webauth-login-options\u0026quot;\u003c/span\u003e, { email });\n    },\n    \u003cspan class=\"hljs-attr\"\u003eloginVerification\u003c/span\u003e: \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e (email, data) =\u0026gt; {\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eAPI\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003emakePostRequest\u003c/span\u003e(\u003cspan class=\"hljs-variable constant_\"\u003eAPI\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eendpoint\u003c/span\u003e + \u003cspan class=\"hljs-string\"\u003e\u0026quot;webauth-login-verification\u0026quot;\u003c/span\u003e, {\n            email,\n            data\n        });                       \n    },\n    \u003cspan class=\"hljs-attr\"\u003eregistrationOptions\u003c/span\u003e: \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e () =\u0026gt; {\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eAPI\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003emakePostRequest\u003c/span\u003e(\u003cspan class=\"hljs-variable constant_\"\u003eAPI\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eendpoint\u003c/span\u003e + \u003cspan class=\"hljs-string\"\u003e\u0026quot;webauth-registration-options\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-title class_\"\u003eAuth\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaccount\u003c/span\u003e);           \n    },\n    \u003cspan class=\"hljs-attr\"\u003eregistrationVerification\u003c/span\u003e: \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e (data) =\u0026gt; {\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eAPI\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003emakePostRequest\u003c/span\u003e(\u003cspan class=\"hljs-variable constant_\"\u003eAPI\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eendpoint\u003c/span\u003e + \u003cspan class=\"hljs-string\"\u003e\u0026quot;webauth-registration-verification\u0026quot;\u003c/span\u003e, {\n            \u003cspan class=\"hljs-attr\"\u003euser\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eAuth\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaccount\u003c/span\u003e,\n            data\n        });                       \n    }\n},\n\u003c/code\u003e\u003c/pre\u003e\n","slug":"setting-up-endpoints","title":"Setting up Endpoints","section":"Using Webauthn","icon":"fingerprint","filePath":"/Users/firt/Library/Mobile Documents/com~apple~CloudDocs/Trainings/FEM/Authentication/fullstack-authentication/lessons/05-using-webauthn/C-setting-up-endpoints.md","nextSlug":"/authentication/lessons/using-webauthn/registering-authentication","prevSlug":"/authentication/lessons/using-webauthn/endpoints-flow"}},"__N_SSG":true},"page":"/lessons/[section]/[slug]","query":{"section":"using-webauthn","slug":"setting-up-endpoints"},"buildId":"PPKJLCZ4kWFtkdu6sn9sr","assetPrefix":"/authentication","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>