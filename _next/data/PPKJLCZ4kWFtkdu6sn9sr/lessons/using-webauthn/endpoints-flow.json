{"pageProps":{"post":{"attributes":{},"html":"<h1 id=\"new-endpoints-and-logic-for-the-new-flow\">New endpoints and logic for the new flow</h1>\n<p>In <code>server.js</code> we need to add a new endpoint</p>\n<pre><code class=\"hljs language-js\">\napp.<span class=\"hljs-title function_\">post</span>(<span class=\"hljs-string\">&quot;/auth/auth-options&quot;</span>, <span class=\"hljs-function\">(<span class=\"hljs-params\">req, res</span>) =&gt;</span> {\n    <span class=\"hljs-keyword\">const</span> user = <span class=\"hljs-title function_\">findUser</span>(req.<span class=\"hljs-property\">body</span>.<span class=\"hljs-property\">email</span>);    \n\n    <span class=\"hljs-keyword\">if</span> (user) {\n        res.<span class=\"hljs-title function_\">send</span>({\n            <span class=\"hljs-attr\">password</span>: <span class=\"hljs-literal\">true</span>,\n            <span class=\"hljs-attr\">google</span>: user.<span class=\"hljs-property\">federated</span> &amp;&amp; user.<span class=\"hljs-property\">federated</span>.<span class=\"hljs-property\">google</span>,\n            <span class=\"hljs-attr\">webauthn</span>: user.<span class=\"hljs-property\">webauthn</span>\n        })\n    } <span class=\"hljs-keyword\">else</span> {\n        res.<span class=\"hljs-title function_\">send</span>({\n            <span class=\"hljs-attr\">password</span>: <span class=\"hljs-literal\">true</span>\n        })\n    }\n});\n</code></pre>\n<p>Then on <code>API.js</code></p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-attr\">checkAuthOptions</span>:  <span class=\"hljs-keyword\">async</span> (user) =&gt; {\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">await</span> <span class=\"hljs-variable constant_\">API</span>.<span class=\"hljs-title function_\">makePostRequest</span>(<span class=\"hljs-variable constant_\">API</span>.<span class=\"hljs-property\">endpoint</span> + <span class=\"hljs-string\">&quot;auth-options&quot;</span>, user);\n},\n</code></pre>\n<p>And finally, on Auth.js we change <code>login</code> while adding a new <code>checkAuthOptions</code> method:</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-attr\">login</span>: <span class=\"hljs-keyword\">async</span> (event) =&gt; {\n    <span class=\"hljs-keyword\">if</span> (event) event.<span class=\"hljs-title function_\">preventDefault</span>();\n    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-title class_\">Auth</span>.<span class=\"hljs-property\">loginStep</span>==<span class=\"hljs-number\">1</span>) {\n        <span class=\"hljs-title class_\">Auth</span>.<span class=\"hljs-title function_\">checkAuthOptions</span>();\n    } <span class=\"hljs-keyword\">else</span> {\n        <span class=\"hljs-keyword\">const</span> user = {\n            <span class=\"hljs-attr\">email</span>: <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">getElementById</span>(<span class=\"hljs-string\">&quot;login_email&quot;</span>).<span class=\"hljs-property\">value</span>,\n            <span class=\"hljs-attr\">password</span>: <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">getElementById</span>(<span class=\"hljs-string\">&quot;login_password&quot;</span>).<span class=\"hljs-property\">value</span>\n\n        };\n        <span class=\"hljs-keyword\">const</span> response = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-variable constant_\">API</span>.<span class=\"hljs-title function_\">login</span>(user);\n        <span class=\"hljs-title class_\">Auth</span>.<span class=\"hljs-title function_\">postLogin</span>(response, { \n            ...user,\n            <span class=\"hljs-attr\">name</span>: response.<span class=\"hljs-property\">name</span>\n        });\n    }\n},\n<span class=\"hljs-attr\">checkAuthOptions</span>: <span class=\"hljs-keyword\">async</span> (event) =&gt; {\n    <span class=\"hljs-keyword\">const</span> response = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-variable constant_\">API</span>.<span class=\"hljs-title function_\">checkAuthOptions</span>({\n        <span class=\"hljs-attr\">email</span>: <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">getElementById</span>(<span class=\"hljs-string\">&quot;login_email&quot;</span>).<span class=\"hljs-property\">value</span>\n    });\n    <span class=\"hljs-keyword\">if</span> (response.<span class=\"hljs-property\">password</span>) {\n        <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">getElementById</span>(<span class=\"hljs-string\">&quot;login_section_password&quot;</span>).<span class=\"hljs-property\">hidden</span> = <span class=\"hljs-literal\">false</span>;\n    }\n    <span class=\"hljs-keyword\">if</span> (response.<span class=\"hljs-property\">webauthn</span>) {\n        <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">getElementById</span>(<span class=\"hljs-string\">&quot;login_section_webauthn&quot;</span>).<span class=\"hljs-property\">hidden</span> = <span class=\"hljs-literal\">false</span>;\n    }\n    <span class=\"hljs-title class_\">Auth</span>.<span class=\"hljs-property\">challenge</span> = response.<span class=\"hljs-property\">challenge</span>;\n    <span class=\"hljs-title class_\">Auth</span>.<span class=\"hljs-property\">loginStep</span> = <span class=\"hljs-number\">2</span>;\n},\n</code></pre>\n","slug":"endpoints-flow","title":"Endpoints Flow","section":"Using Webauthn","icon":"fingerprint","filePath":"/Users/firt/Library/Mobile Documents/com~apple~CloudDocs/Trainings/FEM/Authentication/fullstack-authentication/lessons/05-using-webauthn/B-endpoints-flow.md","nextSlug":"/authentication/lessons/using-webauthn/setting-up-endpoints","prevSlug":"/authentication/lessons/using-webauthn/changing-flow-to-identifier-first"}},"__N_SSG":true}